FROM eclipse-temurin:21-jdk AS builder

WORKDIR /usr/src/app/

COPY gradlew* settings.gradle* build.gradle .
COPY ./gradle ./gradle

RUN chmod +x ./gradlew
RUN ./gradlew
RUN ./gradlew downloadRepos

COPY . .
COPY ./pb ./proto
RUN chmod +x ./gradlew
RUN ./gradlew installDist -PprotoSourceDir=./proto

#####################################################

FROM eclipse-temurin:21-jre

WORKDIR /usr/src/app/

COPY --from=builder /usr/src/app/ ./

ENV AD_PORT 9099

ENTRYPOINT ["./build/install/opentelemetry-demo-ad/bin/Ad"]


----------------------------------------------------------------------------------------------

Let‚Äôs go over this Dockerfile step by step ‚Äî and then I‚Äôll point out a few improvements and potential issues.
üß© What the Dockerfile Does
Stage 1: Builder

FROM eclipse-temurin:21-jdk AS builder

WORKDIR /usr/src/app/

    Uses a full JDK (Java Development Kit) image for building.

    Sets /usr/src/app/ as the working directory.

COPY gradlew* settings.gradle* build.gradle .
COPY ./gradle ./gradle

    Copies Gradle wrapper and configuration files.

RUN chmod +x ./gradlew
RUN ./gradlew
RUN ./gradlew downloadRepos

    Makes the Gradle wrapper executable.

    Runs ./gradlew (likely prints help unless a default task is set).

    Runs downloadRepos ‚Äî likely a custom task that pre-downloads dependencies for caching.

COPY . .
COPY ./pb ./proto
RUN chmod +x ./gradlew
RUN ./gradlew installDist -PprotoSourceDir=./proto

    Copies all source code into the container.

    Copies protobuf files (pb) into proto.

    Rebuilds with installDist (a Gradle application plugin task) to produce a runnable distribution in build/install/....

Stage 2: Runtime

FROM eclipse-temurin:21-jre

WORKDIR /usr/src/app/

COPY --from=builder /usr/src/app/ ./

ENV AD_PORT 9099

ENTRYPOINT ["./build/install/opentelemetry-demo-ad/bin/Ad"]

    Uses a smaller JRE (runtime only, not JDK) image.

    Copies built files from the builder.

    Exposes a port environment variable.

    Starts the Java app via its generated launcher script.
-----------------------------------------------------------------------


‚öôÔ∏è Suggestions / Improvements

    Cache optimization:
    Move dependency download steps before copying the full source ‚Äî this way, Gradle caches dependencies between builds.

COPY gradlew* settings.gradle* build.gradle .
COPY ./gradle ./gradle
RUN chmod +x ./gradlew
RUN ./gradlew --no-daemon dependencies

Then copy source files later:

COPY . .

Combine RUN commands:
You can reduce image layers slightly by chaining commands:

RUN chmod +x ./gradlew && ./gradlew downloadRepos && ./gradlew installDist -PprotoSourceDir=./proto

Simplify final image:
You may not need to copy everything from the builder‚Äîonly the final built distribution:

COPY --from=builder /usr/src/app/build/install/opentelemetry-demo-ad/ ./app/
ENTRYPOINT ["./app/bin/Ad"]

Expose port (optional):
You can explicitly declare the port for clarity:

EXPOSE 9099

Add --no-daemon flag to Gradle:
Recommended for CI/Docker builds to avoid leftover Gradle daemons.

    RUN ./gradlew --no-daemon installDist -PprotoSourceDir=./proto
-----------------------------------------------------------------------
‚úÖ Optimized Example

Here‚Äôs a cleaner, faster version of your Dockerfile:

FROM eclipse-temurin:21-jdk AS builder
WORKDIR /usr/src/app

# Copy Gradle wrapper and config for dependency caching
COPY gradlew* settings.gradle* build.gradle .
COPY gradle gradle
RUN chmod +x ./gradlew
RUN ./gradlew --no-daemon dependencies || return 0

# Copy the rest of the source
COPY . .
COPY pb proto
RUN ./gradlew --no-daemon installDist -PprotoSourceDir=./proto

# Final runtime image
FROM eclipse-temurin:21-jre
WORKDIR /usr/src/app

COPY --from=builder /usr/src/app/build/install/opentelemetry-demo-ad/ ./app/

ENV AD_PORT=9099
EXPOSE 9099

ENTRYPOINT ["./app/bin/Ad"]



-----------------------------------------------------------------------
-----------------------------------------------------------------------


üß© Why You See Multiple COPY Lines

Each COPY instruction in Docker creates a new layer in the image.
Developers sometimes split them up for these reasons:

    Dependency caching ‚Äì
    Copying only Gradle wrapper and config files first (before source code) allows Docker to cache downloaded dependencies between builds.

    COPY gradlew* settings.gradle* build.gradle .
    COPY gradle gradle
    RUN ./gradlew dependencies

    This means that if you change only your source code, Docker won‚Äôt have to redownload all Gradle dependencies.

    Separating steps for clarity ‚Äì
    It can be clearer to separate ‚Äúcopy configs,‚Äù ‚Äúcopy sources,‚Äù and ‚Äúcopy protobuf files,‚Äù especially when multiple build steps or locations are involved.

    Avoiding unnecessary rebuilds ‚Äì
    When you copy everything (COPY . .) early, any small code change invalidates Docker‚Äôs cache for all following layers.
    Splitting it helps rebuild only what‚Äôs needed.

‚öôÔ∏è The Simpler Alternative

If you don‚Äôt care about caching fine-tuning and just want a straightforward build, you can absolutely simplify it.

Here‚Äôs the minimal version that does the same thing:

FROM eclipse-temurin:21-jdk AS builder
WORKDIR /usr/src/app

COPY . .
RUN chmod +x ./gradlew
RUN ./gradlew --no-daemon installDist -PprotoSourceDir=./pb

FROM eclipse-temurin:21-jre
WORKDIR /usr/src/app

COPY --from=builder /usr/src/app/build/install/opentelemetry-demo-ad/ ./app/

ENV AD_PORT=9099
EXPOSE 9099

ENTRYPOINT ["./app/bin/Ad"]

‚úÖ Pros:

    Much shorter and easier to read.

    Works fine for most small/medium projects.

‚ùå Cons:

    Builds are slower when dependencies change.

    Doesn‚Äôt take full advantage of Docker‚Äôs caching.

üß† Bottom Line

Use many COPY commands only if you want:

    Faster rebuilds with caching.

    Fine control over what invalidates the cache.

Otherwise, one COPY . . is perfectly fine ‚Äî cleaner, simpler, and easier to maintain.

